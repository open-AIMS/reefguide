@let sliderDefs = enabledSliderDefs();
@let regions = regions$ | async;
<div class="scrollable">
  <form [formGroup]="form">
    <mat-form-field class="region-select">
      <mat-label>Region</mat-label>
      <mat-select formControlName="region">
        @for (region of regions; track region.name) {
          <mat-option [value]="region.name">{{ region.display_name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    @if (regions?.length === 0) {
      <div class="error-message">Database is missing regions information!</div>
    }
    @if (sliderDefs) {
      <div formGroupName="criteria">
        @for (sliderDef of sliderDefs; track sliderDef.criteria.id) {
          @let c = sliderDef.criteria;
          @let slider = sliderDef.slider;
          @let criteriaLayer =
            slider.criteriaLayerId !== undefined
              ? mapService.criteriaLayers[slider.criteriaLayerId]
              : undefined;
          @let visible = criteriaLayer?.visible();
          @let loading = criteriaLayer?.loading();
          @let progress = criteriaLayer?.loadingProgress();
          <div class="criteria" [class.visible]="visible === true">
            <div class="row">
              <span class="label" [matTooltip]="c.units">{{ c.display_title }}</span>
              @if (loading) {
                <mat-progress-spinner
                  diameter="24"
                  [mode]="progress === undefined ? 'indeterminate' : 'determinate'"
                  [value]="(progress ?? 0) * 100"
                ></mat-progress-spinner>
              }
              @if (visible != null) {
                @if (slider.previewAlert) {
                  <mat-icon [matTooltip]="slider.previewAlert" matTooltipPosition="below">
                    warning
                  </mat-icon>
                }
                <button
                  mat-icon-button
                  class="visibility"
                  (click)="mapService.showCriteriaLayer(slider.criteriaLayerId, !visible)"
                >
                  <mat-icon>{{ visible ? 'visibility' : 'visibility_off' }}</mat-icon>
                </button>
              }
            </div>
            <p class="subtitle mat-body-small">{{ c.display_subtitle }}</p>
            <mat-slider [min]="slider.min" [max]="slider.max" discrete="true" [step]="slider.step">
              <input
                matSliderStartThumb
                [formControlName]="`${c.payload_property_prefix}min`"
                [matTooltip]="c.min_tooltip"
                (blur)="onBlurSlider(sliderDef)"
              />
              <input
                matSliderEndThumb
                [formControlName]="`${c.payload_property_prefix}max`"
                [matTooltip]="c.max_tooltip"
                (blur)="onBlurSlider(sliderDef)"
              />
            </mat-slider>
          </div>
        }
      </div>
      @let enableSiteSuitability = form.get('enableSiteSuitability')?.value === true;
      <mat-slide-toggle labelPosition="before" formControlName="enableSiteSuitability">
        Site Suitability
      </mat-slide-toggle>
      <div class="ss-container" formGroupName="siteSuitability">
        @if (enableSiteSuitability) {
          <div>
            <div class="row">
              <mat-form-field>
                <mat-label>X (meters)</mat-label>
                <input type="number" matInput formControlName="x_dist" />
              </mat-form-field>
              <mat-form-field>
                <mat-label>Y (meters)</mat-label>
                <input type="number" matInput formControlName="y_dist" />
              </mat-form-field>
            </div>
            <header class="label">Threshold</header>
            <mat-slider min="0" max="100" discrete>
              <input matSliderThumb formControlName="threshold" />
            </mat-slider>
          </div>
        }
      </div>
    }
  </form>
</div>
