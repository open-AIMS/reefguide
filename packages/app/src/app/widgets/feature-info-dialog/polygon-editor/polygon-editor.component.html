<div class="polygon-editor">
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading polygon details...</p>
    </div>
  } @else if (polygonDetails()) {
    <div class="polygon-content">
      <!-- Polygon Details Section -->
      <mat-card class="details-card">
        <mat-card-header>
          <mat-card-title>Polygon Details</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Polygon ID:</span>
            <span class="detail-value">{{ polygonDetails()!.id }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Created By:</span>
            <span class="detail-value">{{ polygonDetails()!.user.email }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Created At:</span>
            <span class="detail-value">{{ formatDate(polygonDetails()!.created_at) }}</span>
          </div>

          <mat-divider class="section-divider"></mat-divider>

          @if (areaM2()) {
            <div class="detail-row">
              <span class="detail-label">Area:</span>
              <span class="detail-value">{{ formatArea(areaM2()!) }} mÂ²</span>
            </div>
          }

          @if (boundingBox()) {
            <div class="detail-row">
              <span class="detail-label">Bounding Box:</span>
              <span class="detail-value">{{ formatBoundingBox(boundingBox()!) }}</span>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Notes Section -->
      <mat-card class="notes-card">
        <mat-card-header>
          <mat-card-title>
            Comments
            <span class="note-count">({{ polygonDetails()!.notes.length }})</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Notes List -->
          <div class="notes-list">
            @if (polygonDetails()!.notes.length === 0) {
              <div class="no-notes">
                <p>No comments yet. Be the first to add one!</p>
              </div>
            } @else {
              @for (note of polygonDetails()!.notes; track trackByNoteId($index, note)) {
                <div class="note-item">
                  <div class="note-header">
                    <span class="note-author">{{ note.user.email }}</span>
                    <span class="note-time">{{ getRelativeTime(note.created_at) }}</span>
                  </div>
                  <div class="note-content">{{ note.content }}</div>
                </div>
              }
            }
          </div>

          <mat-divider class="input-divider"></mat-divider>

          <!-- Add Note Input -->
          <div class="add-note">
            <mat-form-field appearance="outline" class="note-input">
              <mat-label>Add a comment</mat-label>
              <textarea
                matInput
                [(ngModel)]="newNoteContent"
                placeholder="Type your comment here..."
                rows="3"
                [disabled]="submittingNote()"
                (keydown.control.enter)="submitNote()"
              ></textarea>
              <mat-hint>Press Ctrl+Enter to submit</mat-hint>
            </mat-form-field>

            <button
              mat-raised-button
              color="primary"
              (click)="submitNote()"
              [disabled]="!newNoteContent.trim() || submittingNote()"
              class="submit-button"
            >
              @if (submittingNote()) {
                <mat-spinner diameter="20"></mat-spinner>
              }
              <span>Post Comment</span>
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  } @else {
    <div class="error-container">
      <p>Failed to load polygon details</p>
    </div>
  }
</div>
