<!-- Success Message -->
@if (successMessage()) {
  <div class="success-message" role="alert" aria-live="polite">
    <mat-icon>check_circle</mat-icon>
    <span>{{ successMessage() }}</span>
  </div>
}

<form [formGroup]="confirmForm" (ngSubmit)="onSubmit()" class="auth-form">
  <!-- Reset Code Field -->
  <mat-form-field appearance="outline">
    <mat-label>Reset Code</mat-label>
    <mat-icon matPrefix>pin</mat-icon>
    <input
      matInput
      type="text"
      formControlName="code"
      placeholder="Enter 6-digit code from email"
      maxlength="10"
    />
    @if (confirmForm.get('code')?.hasError('required')) {
      <mat-error>Reset code is required</mat-error>
    }
    @if (confirmForm.get('code')?.hasError('minlength')) {
      <mat-error>Reset code must be at least 6 characters</mat-error>
    }
    @if (confirmForm.get('code')?.hasError('maxlength')) {
      <mat-error>Reset code is too long</mat-error>
    }
  </mat-form-field>

  <!-- New Password Field -->
  <mat-form-field appearance="outline">
    <mat-label>New Password</mat-label>
    <mat-icon matPrefix>lock</mat-icon>
    <input
      matInput
      [type]="hidePassword() ? 'password' : 'text'"
      formControlName="newPassword"
      placeholder="Enter new password"
      autocomplete="new-password"
    />
    <button
      mat-icon-button
      matSuffix
      type="button"
      (click)="togglePasswordVisibility()"
      [attr.aria-label]="hidePassword() ? 'Show password' : 'Hide password'"
    >
      <mat-icon>{{ hidePassword() ? 'visibility' : 'visibility_off' }}</mat-icon>
    </button>
    @if (confirmForm.get('newPassword')?.hasError('required')) {
      <mat-error>Password is required</mat-error>
    }
    @if (confirmForm.get('newPassword')?.hasError('minlength')) {
      <mat-error>Password must be at least 8 characters long</mat-error>
    }
  </mat-form-field>

  <!-- Confirm Password Field -->
  <mat-form-field appearance="outline">
    <mat-label>Confirm Password</mat-label>
    <mat-icon matPrefix>lock</mat-icon>
    <input
      matInput
      [type]="hideConfirmPassword() ? 'password' : 'text'"
      formControlName="confirmPassword"
      placeholder="Confirm new password"
      autocomplete="new-password"
    />
    <button
      mat-icon-button
      matSuffix
      type="button"
      (click)="toggleConfirmPasswordVisibility()"
      [attr.aria-label]="hideConfirmPassword() ? 'Show password' : 'Hide password'"
    >
      <mat-icon>{{ hideConfirmPassword() ? 'visibility' : 'visibility_off' }}</mat-icon>
    </button>
    @if (confirmForm.get('confirmPassword')?.hasError('required')) {
      <mat-error>Please confirm your password</mat-error>
    }
    @if (confirmForm.get('confirmPassword')?.hasError('mismatch')) {
      <mat-error>Passwords do not match</mat-error>
    }
  </mat-form-field>

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="error-message" role="alert" aria-live="polite">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ errorMessage() }}</span>
    </div>
  }

  <!-- Submit Button -->
  <button
    mat-raised-button
    color="primary"
    type="submit"
    class="auth-button"
    [disabled]="!canSubmit()"
  >
    @if (isConfirming()) {
      <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
    } @else {
      <mat-icon>save</mat-icon>
    }
    <span>{{ isConfirming() ? 'Updating password...' : 'Update Password' }}</span>
  </button>
</form>

<!-- Navigation Links -->
<mat-divider></mat-divider>
<div class="mode-switch">
  <p>
    Need to start again?
    <button mat-button color="primary" type="button" (click)="switchToResetRequest()">
      Forgotten my password
    </button>
  </p>
  <p>
    Remember your password?
    <button mat-button color="primary" type="button" (click)="switchToLogin()">
      Back to Sign In
    </button>
  </p>
</div>
